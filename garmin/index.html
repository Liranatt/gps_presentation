<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Garmin Health Intelligence | Liran Attar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      --bg: #0a0a0f;
      --bg-soft: #0d1117;
      --surface: rgba(255, 255, 255, 0.03);
      --surface-2: rgba(255, 255, 255, 0.04);
      --text: #ffffff;
      --text-dim: rgba(255, 255, 255, 0.45);
      --line: rgba(255, 255, 255, 0.08);
      --brand: #00f5a0;
      --brand-dark: #00d9f5;
      --brand-soft: rgba(0, 245, 160, 0.14);
      --warn-soft: rgba(245, 197, 66, 0.18);
      --warn-text: #f5c542;
      --bad-soft: rgba(245, 87, 108, 0.18);
      --bad-text: #f5576c;
      --radius-lg: 22px;
      --radius-md: 14px;
      --shadow-lg: 0 22px 60px -28px rgba(0, 0, 0, 0.65);
      --shadow-md: 0 12px 28px -20px rgba(0, 0, 0, 0.55);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Inter", sans-serif;
      background:
        radial-gradient(circle at 15% 0%, rgba(0, 245, 160, 0.16) 0%, transparent 40%),
        radial-gradient(circle at 85% 0%, rgba(102, 126, 234, 0.18) 0%, transparent 34%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .page {
      width: min(1200px, calc(100% - 32px));
      margin: 18px auto 36px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
      padding: 10px 0;
    }

    .topbar-links {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .chip-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.04);
      color: rgba(255, 255, 255, 0.72);
      text-decoration: none;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.2px;
      transition: all 0.2s ease;
    }

    .chip-link:hover {
      border-color: rgba(255, 255, 255, 0.22);
      background: rgba(255, 255, 255, 0.09);
      color: #fff;
      transform: translateY(-1px);
    }

    .hero {
      background: linear-gradient(140deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 52%, rgba(255,255,255,0.04) 100%);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 24px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }

    .hero::after {
      content: "";
      position: absolute;
      top: -80px;
      right: -80px;
      width: 220px;
      height: 220px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(0, 245, 160, 0.28) 0%, transparent 70%);
      pointer-events: none;
    }

    .hero-inner {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: 1.35fr 1fr;
      gap: 16px;
      align-items: center;
    }

    .hero h1 {
      font-family: "Space Grotesk", sans-serif;
      font-size: clamp(28px, 4.8vw, 44px);
      line-height: 1.05;
      letter-spacing: -1px;
      margin-bottom: 10px;
      color: #fff;
    }

    .hero p {
      color: rgba(255, 255, 255, 0.68);
      font-size: 15px;
      line-height: 1.6;
      max-width: 64ch;
    }

    .hero-kpis {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .hero-kpi {
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      padding: 12px;
      min-height: 86px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: center;
    }

    .hero-kpi .label {
      font-size: 11px;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.45);
      margin-bottom: 5px;
      font-weight: 700;
    }

    .hero-kpi .value {
      font-size: 23px;
      font-weight: 800;
      line-height: 1;
      color: #fff;
    }

    .mode-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 14px;
    }

    .mode-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      color: rgba(255, 255, 255, 0.75);
      text-decoration: none;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      transition: all 0.2s ease;
    }

    .mode-pill:hover {
      border-color: rgba(0, 245, 160, 0.38);
      color: #ffffff;
      background: rgba(0, 245, 160, 0.08);
      transform: translateY(-1px);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 16px;
    }

    .stack {
      display: grid;
      gap: 16px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(12px);
      overflow: hidden;
    }

    .card-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      background: var(--surface-2);
    }

    .card-title {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: "Space Grotesk", sans-serif;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: -0.2px;
      color: #fff;
    }

    .status {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.2px;
      min-width: 120px;
      text-align: center;
      border: 1px solid transparent;
    }

    .status.loading {
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.68);
      border-color: rgba(255, 255, 255, 0.14);
    }

    .status.ok {
      background: var(--brand-soft);
      color: var(--brand-dark);
      border-color: rgba(0, 245, 160, 0.35);
    }

    .status.warm {
      background: var(--warn-soft);
      color: var(--warn-text);
      border-color: rgba(245, 197, 66, 0.35);
    }

    .status.fail {
      background: var(--bad-soft);
      color: var(--bad-text);
      border-color: rgba(245, 87, 108, 0.35);
    }

    .card-body {
      padding: 16px;
    }

    .settings-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr auto;
      align-items: end;
    }

    .field {
      display: grid;
      gap: 6px;
    }

    .field label {
      font-size: 12px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.55);
      letter-spacing: 0.3px;
    }

    .field input {
      width: 100%;
      padding: 11px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }

    .field input:focus {
      border-color: rgba(0, 245, 160, 0.45);
      box-shadow: 0 0 0 3px rgba(0, 245, 160, 0.13);
    }

    .button {
      border: none;
      border-radius: 10px;
      padding: 11px 14px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      text-align: center;
      transition: all 0.2s ease;
      text-decoration: none;
      white-space: nowrap;
    }

    .button.primary {
      background: var(--brand);
      color: #fff;
    }

    .button.primary:hover {
      background: var(--brand-dark);
      transform: translateY(-1px);
    }

    .button.ghost {
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.82);
      border: 1px solid rgba(255, 255, 255, 0.13);
    }

    .button.ghost:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .help {
      margin-top: 8px;
      color: rgba(255, 255, 255, 0.55);
      font-size: 12px;
      line-height: 1.5;
    }

    .metrics-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .metric {
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      padding: 13px;
      background: rgba(255, 255, 255, 0.04);
      min-height: 104px;
      display: grid;
      align-content: center;
      justify-items: center;
      text-align: center;
    }

    .metric-label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      letter-spacing: 0.3px;
      margin-bottom: 6px;
      font-weight: 700;
    }

    .metric-value {
      font-family: "Space Grotesk", sans-serif;
      font-size: 30px;
      line-height: 1;
      font-weight: 700;
      color: #fff;
    }

    .metric-meta {
      margin-top: 5px;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.45);
    }

    .trend-status {
      margin-bottom: 10px;
    }

    .trend-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .trend-card {
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
      padding: 10px;
      display: grid;
      gap: 7px;
    }

    .trend-top {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
    }

    .trend-label {
      font-size: 12px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.6);
      letter-spacing: 0.3px;
    }

    .trend-value {
      font-family: "Space Grotesk", sans-serif;
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      line-height: 1;
    }

    .spark {
      width: 100%;
      height: 68px;
      border-radius: 9px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .spark path {
      fill: none;
      stroke: var(--brand);
      stroke-width: 2.2;
      stroke-linejoin: round;
      stroke-linecap: round;
    }

    .spark circle {
      fill: #fff;
      stroke: var(--brand);
      stroke-width: 1.7;
    }

    .trend-delta {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .trend-delta.up {
      color: #4ade80;
    }

    .trend-delta.down {
      color: #fb7185;
    }

    .trend-delta.flat {
      color: rgba(255, 255, 255, 0.5);
    }

    .insights {
      display: grid;
      gap: 10px;
    }

    .insight {
      border: 1px solid rgba(255, 255, 255, 0.11);
      border-radius: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      display: grid;
      gap: 6px;
    }

    .insight-top {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .insight-agent {
      font-size: 11px;
      font-weight: 800;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: var(--brand);
      background: var(--brand-soft);
      border: 1px solid rgba(0, 245, 160, 0.22);
      padding: 4px 8px;
      border-radius: 999px;
    }

    .insight-time {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.48);
      font-weight: 700;
    }

    .insight p {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.82);
      line-height: 1.6;
    }

    .insight-detail {
      border-top: 1px dashed rgba(255, 255, 255, 0.14);
      padding-top: 8px;
    }

    .insight-detail summary {
      cursor: pointer;
      color: rgba(255, 255, 255, 0.65);
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.2px;
      list-style: none;
    }

    .insight-detail summary::-webkit-details-marker {
      display: none;
    }

    .insight-detail pre {
      margin-top: 8px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.02);
      color: rgba(255, 255, 255, 0.74);
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      max-height: 220px;
      overflow: auto;
    }

    .empty {
      color: rgba(255, 255, 255, 0.52);
      font-size: 13px;
      text-align: center;
      padding: 8px;
      border: 1px dashed rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.03);
    }

    .chat-wrap {
      display: grid;
      gap: 10px;
      height: 100%;
      min-height: 520px;
      grid-template-rows: 1fr auto;
    }

    .chat-log {
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.04);
      padding: 12px;
      overflow: auto;
      display: grid;
      gap: 10px;
    }

    .msg {
      max-width: 92%;
      padding: 10px 11px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.6;
      word-break: break-word;
      border: 1px solid transparent;
    }

    .msg.user {
      justify-self: end;
      background: rgba(102, 126, 234, 0.16);
      border-color: rgba(102, 126, 234, 0.34);
      color: #fff;
      border-bottom-right-radius: 5px;
    }

    .msg.bot {
      justify-self: start;
      background: rgba(0, 245, 160, 0.1);
      border-color: rgba(0, 245, 160, 0.25);
      color: rgba(255, 255, 255, 0.9);
      border-bottom-left-radius: 5px;
    }

    .msg.system {
      justify-self: center;
      background: rgba(245, 197, 66, 0.12);
      border-color: rgba(245, 197, 66, 0.3);
      color: #f5c542;
      text-align: center;
      max-width: 100%;
      font-size: 12px;
      padding: 8px 10px;
    }

    .chat-form {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }

    .chat-form textarea {
      min-height: 52px;
      max-height: 120px;
      resize: vertical;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 12px;
      padding: 12px;
      font-family: inherit;
      font-size: 14px;
      line-height: 1.45;
      color: var(--text);
      background: rgba(255, 255, 255, 0.04);
      outline: none;
    }

    .chat-form textarea:focus {
      border-color: rgba(0, 245, 160, 0.45);
      box-shadow: 0 0 0 3px rgba(0, 245, 160, 0.13);
    }

    .chat-actions {
      display: grid;
      gap: 8px;
      align-content: stretch;
      min-width: 120px;
    }

    .footer-note {
      margin-top: 12px;
      color: rgba(255, 255, 255, 0.48);
      font-size: 12px;
      text-align: center;
      line-height: 1.5;
    }

    .loading-row {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: rgba(255, 255, 255, 0.6);
      font-size: 13px;
      font-weight: 700;
    }

    .spin {
      animation: spin 0.9s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 1000px) {
      .hero-inner,
      .layout {
        grid-template-columns: 1fr;
      }

      .chat-wrap {
        min-height: 500px;
      }
    }

    @media (max-width: 720px) {
      .page {
        width: calc(100% - 16px);
        margin-top: 10px;
      }

      .hero,
      .card-body {
        padding: 14px;
      }

      .card-head {
        padding: 11px 14px;
      }

      .hero-kpis,
      .metrics-grid,
      .trend-grid {
        grid-template-columns: 1fr;
      }

      .settings-grid,
      .chat-form {
        grid-template-columns: 1fr;
      }

      .chat-actions {
        min-width: 0;
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="topbar">
      <div class="topbar-links">
        <a class="chip-link" href="/">
          <i data-lucide="arrow-left" style="width:14px;height:14px;"></i>
          Portfolio
        </a>
        <a class="chip-link" href="https://github.com/Liranatt/garmin-project" target="_blank" rel="noopener noreferrer">
          <i data-lucide="github" style="width:14px;height:14px;"></i>
          Project Repo
        </a>
      </div>
      <span id="statusBadge" class="status loading">
        <i data-lucide="loader-2" class="spin" style="width:14px;height:14px;"></i>
        Connecting
      </span>
    </header>

    <section class="hero">
      <div class="hero-inner">
        <div>
          <h1>Garmin Health Intelligence Dashboard v3</h1>
          <p>
            Deterministic statistics first, multi-agent reasoning second. This page mirrors your Streamlit v3
            structure and consumes your Heroku API for snapshot metrics, insights, and interactive agent chat.
          </p>
        </div>
        <div class="hero-kpis">
          <article class="hero-kpi">
            <span class="label">Resting HR</span>
            <strong class="value" id="heroRestHr">--</strong>
          </article>
          <article class="hero-kpi">
            <span class="label">HRV</span>
            <strong class="value" id="heroHrv">--</strong>
          </article>
          <article class="hero-kpi">
            <span class="label">Sleep Score</span>
            <strong class="value" id="heroSleep">--</strong>
          </article>
          <article class="hero-kpi">
            <span class="label">Body Battery</span>
            <strong class="value" id="heroBattery">--</strong>
          </article>
        </div>
      </div>
    </section>

    <nav class="mode-nav" aria-label="Dashboard sections">
      <a class="mode-pill" href="#snapshot">Overview</a>
      <a class="mode-pill" href="#insights">Insights</a>
      <a class="mode-pill" href="#chat">Agent Chat</a>
      <a class="mode-pill" href="#trends">Trends</a>
      <a class="mode-pill" href="#roadmap">Correlations</a>
      <a class="mode-pill" href="#roadmap">Deep Dive</a>
      <a class="mode-pill" href="#roadmap">Date Explorer</a>
      <a class="mode-pill" href="#roadmap">Daily Input</a>
      <a class="mode-pill" href="#roadmap">Agent Analysis</a>
      <a class="mode-pill" href="#roadmap">Goals</a>
    </nav>

    <main class="layout">
      <section class="stack">

        <article id="snapshot" class="card">
          <header class="card-head">
            <h2 class="card-title">
              <i data-lucide="heart-pulse" style="width:17px;height:17px;"></i>
              Latest Snapshot
            </h2>
            <button class="button ghost" id="refreshSnapshotBtn" type="button">
              <i data-lucide="refresh-cw" style="width:14px;height:14px;"></i>
              Refresh
            </button>
          </header>
          <div class="card-body">
            <div id="snapshotStatus" class="loading-row">
              <i data-lucide="loader-2" class="spin" style="width:14px;height:14px;"></i>
              Loading snapshot metrics...
            </div>
            <div class="metrics-grid" id="metricsGrid" hidden>
              <article class="metric">
                <div class="metric-label">Resting Heart Rate</div>
                <div class="metric-value" id="mRestHr">--</div>
                <div class="metric-meta">bpm</div>
              </article>
              <article class="metric">
                <div class="metric-label">HRV</div>
                <div class="metric-value" id="mHrv">--</div>
                <div class="metric-meta">ms</div>
              </article>
              <article class="metric">
                <div class="metric-label">Sleep Score</div>
                <div class="metric-value" id="mSleep">--</div>
                <div class="metric-meta">0-100</div>
              </article>
              <article class="metric">
                <div class="metric-label">Body Battery</div>
                <div class="metric-value" id="mBattery">--</div>
                <div class="metric-meta">0-100</div>
              </article>
              <article class="metric">
                <div class="metric-label">Stress</div>
                <div class="metric-value" id="mStress">--</div>
                <div class="metric-meta">daily index</div>
              </article>
              <article class="metric">
                <div class="metric-label">Training Load</div>
                <div class="metric-value" id="mLoad">--</div>
                <div class="metric-meta">7-day</div>
              </article>
            </div>
          </div>
        </article>

        <article id="trends" class="card">
          <header class="card-head">
            <h2 class="card-title">
              <i data-lucide="line-chart" style="width:17px;height:17px;"></i>
              Daily Trends (Last 90 Days)
            </h2>
            <button class="button ghost" id="refreshHistoryBtn" type="button">
              <i data-lucide="refresh-cw" style="width:14px;height:14px;"></i>
              Refresh
            </button>
          </header>
          <div class="card-body">
            <div id="historyStatus" class="loading-row trend-status">
              <i data-lucide="loader-2" class="spin" style="width:14px;height:14px;"></i>
              Loading trend history...
            </div>
            <div class="trend-grid" id="trendGrid" hidden></div>
          </div>
        </article>

        <article id="insights" class="card">
          <header class="card-head">
            <h2 class="card-title">
              <i data-lucide="sparkles" style="width:17px;height:17px;"></i>
              Agent Insights
            </h2>
            <button class="button ghost" id="refreshInsightsBtn" type="button">
              <i data-lucide="refresh-cw" style="width:14px;height:14px;"></i>
              Refresh
            </button>
          </header>
          <div class="card-body">
            <div id="insightsList" class="insights">
              <div class="loading-row">
                <i data-lucide="loader-2" class="spin" style="width:14px;height:14px;"></i>
                Loading latest insights...
              </div>
            </div>
          </div>
        </article>
      </section>

      <section id="chat" class="card">
        <header class="card-head">
          <h2 class="card-title">
            <i data-lucide="messages-square" style="width:17px;height:17px;"></i>
            Interactive Agent Chat
          </h2>
        </header>
        <div class="card-body chat-wrap">
          <div id="chatLog" class="chat-log">
            <div class="msg system">Ask the agent about sleep patterns, training load, correlations, or recovery trends.</div>
          </div>

          <form id="chatForm" class="chat-form">
            <textarea id="chatInput" placeholder="Example: Why did my recovery score drop this week?"></textarea>
            <div class="chat-actions">
              <button class="button primary" type="submit" id="sendBtn">
                <i data-lucide="send" style="width:14px;height:14px;"></i>
                Send
              </button>
              <button class="button ghost" type="button" id="clearChatBtn">
                <i data-lucide="trash-2" style="width:14px;height:14px;"></i>
                Clear
              </button>
            </div>
          </form>

          <p class="footer-note">
            This UI is Streamlit-free. It talks directly to your backend API so you can fully host on Heroku.
          </p>
        </div>
      </section>
    </main>

    <section id="roadmap" class="card" style="margin-top:16px;">
      <header class="card-head">
        <h2 class="card-title">
          <i data-lucide="map" style="width:17px;height:17px;"></i>
          Streamlit v3 Page Map
        </h2>
      </header>
      <div class="card-body">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Page</th>
                <th>Frontend Status</th>
                <th>Backend Endpoint Needed</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Overview</td>
                <td>Implemented</td>
                <td><code>/api/v1/snapshot/latest</code>, <code>/api/v1/insights/latest</code></td>
              </tr>
              <tr>
                <td>Agent Chat</td>
                <td>Implemented</td>
                <td><code>/api/v1/chat</code></td>
              </tr>
              <tr>
                <td>Trends</td>
                <td>Implemented</td>
                <td><code>/api/v1/metrics/history?days=90</code></td>
              </tr>
              <tr>
                <td>Correlations</td>
                <td>Design ready</td>
                <td><code>/api/v1/correlations/summary</code>, matrix endpoint</td>
              </tr>
              <tr>
                <td>Deep Dive</td>
                <td>Design ready</td>
                <td>history endpoint + metric query filters</td>
              </tr>
              <tr>
                <td>Date Explorer</td>
                <td>Design ready</td>
                <td><code>/api/v1/date/&lt;YYYY-MM-DD&gt;</code></td>
              </tr>
              <tr>
                <td>Daily Input</td>
                <td>Design ready</td>
                <td><code>/api/v1/daily/wellness</code>, <code>/api/v1/daily/nutrition</code></td>
              </tr>
              <tr>
                <td>Agent Analysis</td>
                <td>Design ready</td>
                <td><code>/api/v1/analysis/run</code></td>
              </tr>
              <tr>
                <td>Goals</td>
                <td>Design ready</td>
                <td><code>/api/v1/goals/progress</code> (or weekly history endpoint)</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    const DEFAULT_API_BASE = "https://garmin-health-liran-f16faec73fc5.herokuapp.com";

    const state = {
      apiBase: DEFAULT_API_BASE,
      snapshot: null,
      insights: [],
      history: []
    };

    const el = {
      statusBadge: document.getElementById("statusBadge"),
      refreshSnapshotBtn: document.getElementById("refreshSnapshotBtn"),
      refreshHistoryBtn: document.getElementById("refreshHistoryBtn"),
      refreshInsightsBtn: document.getElementById("refreshInsightsBtn"),
      snapshotStatus: document.getElementById("snapshotStatus"),
      metricsGrid: document.getElementById("metricsGrid"),
      historyStatus: document.getElementById("historyStatus"),
      trendGrid: document.getElementById("trendGrid"),
      insightsList: document.getElementById("insightsList"),
      chatForm: document.getElementById("chatForm"),
      chatInput: document.getElementById("chatInput"),
      chatLog: document.getElementById("chatLog"),
      sendBtn: document.getElementById("sendBtn"),
      clearChatBtn: document.getElementById("clearChatBtn"),
      heroRestHr: document.getElementById("heroRestHr"),
      heroHrv: document.getElementById("heroHrv"),
      heroSleep: document.getElementById("heroSleep"),
      heroBattery: document.getElementById("heroBattery"),
      mRestHr: document.getElementById("mRestHr"),
      mHrv: document.getElementById("mHrv"),
      mSleep: document.getElementById("mSleep"),
      mBattery: document.getElementById("mBattery"),
      mStress: document.getElementById("mStress"),
      mLoad: document.getElementById("mLoad")
    };



    function endpoint(path) {
      return `${state.apiBase}${path}`;
    }

    function fmt(value, fallback = "--") {
      if (value === null || value === undefined || value === "") {
        return fallback;
      }
      if (typeof value === "number" && Number.isFinite(value)) {
        return Number.isInteger(value) ? String(value) : value.toFixed(1);
      }
      return String(value);
    }

    function setStatus(kind, text, icon = "activity") {
      el.statusBadge.className = `status ${kind}`;
      el.statusBadge.innerHTML = `<i data-lucide="${icon}" style="width:14px;height:14px;"></i>${text}`;
      lucide.createIcons();
    }

    function findFirst(source, keys) {
      for (const key of keys) {
        const value = source?.[key];
        if (value !== undefined && value !== null && value !== "") {
          return value;
        }
      }
      return null;
    }

    function normalizeSnapshot(data) {
      const source = data?.snapshot || data?.data || data || {};
      return {
        restingHr: findFirst(source, ["resting_hr", "restingHeartRate", "rhr", "resting_hr_avg"]),
        hrv: findFirst(source, ["hrv", "hrv_ms", "rmssd"]),
        sleep: findFirst(source, ["sleep_score", "sleepScore", "sleep"]),
        battery: findFirst(source, ["body_battery", "bodyBattery", "battery"]),
        stress: findFirst(source, ["stress", "stress_score", "avg_stress"]),
        load: findFirst(source, ["training_load", "load", "acute_load", "seven_day_load"]),
        timestamp: findFirst(source, ["timestamp", "created_at", "date", "as_of"])
      };
    }

    function numberOrNull(value) {
      const n = Number(value);
      return Number.isFinite(n) ? n : null;
    }

    function average(values) {
      if (!values.length) {
        return null;
      }
      return values.reduce((acc, value) => acc + value, 0) / values.length;
    }

    function normalizeHistory(payload) {
      const rows = Array.isArray(payload)
        ? payload
        : Array.isArray(payload?.data)
          ? payload.data
          : Array.isArray(payload?.history)
            ? payload.history
            : [];

      return rows.map((row) => ({
        date: findFirst(row, ["date", "timestamp", "as_of"]),
        restingHr: numberOrNull(findFirst(row, ["resting_hr", "restingHr", "rhr"])),
        hrv: numberOrNull(findFirst(row, ["hrv", "hrv_last_night", "hrv_ms", "rmssd"])),
        sleep: numberOrNull(findFirst(row, ["sleep_score", "sleepScore", "sleep"])),
        stress: numberOrNull(findFirst(row, ["stress", "stress_level", "stress_score", "avg_stress"])),
        battery: numberOrNull(findFirst(row, ["battery", "body_battery", "bb_peak"])),
        load: numberOrNull(findFirst(row, ["training_load", "daily_load_acute", "load", "acute_load"]))
      })).filter((row) => row.date).sort((a, b) => String(a.date).localeCompare(String(b.date)));
    }

    function sparklineModel(values, width = 320, height = 68, pad = 7) {
      const points = values.filter((value) => value !== null && value !== undefined);
      if (points.length === 0) {
        return { path: "", lastX: 0, lastY: 0 };
      }

      const min = Math.min(...points);
      const max = Math.max(...points);
      const range = max - min || 1;
      const step = points.length > 1 ? (width - (pad * 2)) / (points.length - 1) : 0;

      const mapped = points.map((value, index) => {
        const x = pad + (index * step);
        const y = height - pad - (((value - min) / range) * (height - (pad * 2)));
        return { x, y };
      });

      const path = mapped.map((point, index) => `${index === 0 ? "M" : "L"} ${point.x.toFixed(2)} ${point.y.toFixed(2)}`).join(" ");
      const last = mapped[mapped.length - 1];
      return { path, lastX: last.x, lastY: last.y };
    }

    function trendDelta(values) {
      const clean = values.filter((value) => value !== null && value !== undefined);
      if (clean.length < 14) {
        return null;
      }
      const recent = average(clean.slice(-7));
      const previous = average(clean.slice(-14, -7));
      if (recent === null || previous === null || previous === 0) {
        return null;
      }
      return ((recent - previous) / Math.abs(previous)) * 100;
    }

    function trendClass(delta, higherIsBetter) {
      if (delta === null || Math.abs(delta) < 0.5) {
        return "flat";
      }
      if (higherIsBetter) {
        return delta >= 0 ? "up" : "down";
      }
      return delta >= 0 ? "down" : "up";
    }

    function renderHistory(rows) {
      state.history = rows;
      if (!rows.length) {
        el.trendGrid.hidden = true;
        el.historyStatus.innerHTML = '<span class="empty">No daily history rows returned yet.</span>';
        return;
      }

      const metrics = [
        { key: "restingHr", label: "Resting HR", unit: "bpm", higherIsBetter: false },
        { key: "hrv", label: "HRV", unit: "ms", higherIsBetter: true },
        { key: "sleep", label: "Sleep Score", unit: "", higherIsBetter: true },
        { key: "stress", label: "Stress", unit: "", higherIsBetter: false },
        { key: "battery", label: "Body Battery", unit: "", higherIsBetter: true },
        { key: "load", label: "Training Load", unit: "", higherIsBetter: true }
      ];

      const cards = metrics.map((metric) => {
        const values = rows.map((row) => row[metric.key]).filter((value) => value !== null && value !== undefined);
        if (!values.length) {
          return `
            <article class="trend-card">
              <div class="trend-top">
                <span class="trend-label">${metric.label}</span>
                <strong class="trend-value">--</strong>
              </div>
              <div class="trend-delta flat">No data</div>
            </article>
          `;
        }

        const latest = values[values.length - 1];
        const spark = sparklineModel(values);
        const delta = trendDelta(values);
        const klass = trendClass(delta, metric.higherIsBetter);
        const deltaText = delta === null
          ? "Need at least 14 data points"
          : `${delta > 0 ? "+" : ""}${delta.toFixed(1)}% vs previous 7 days`;

        return `
          <article class="trend-card">
            <div class="trend-top">
              <span class="trend-label">${metric.label}</span>
              <strong class="trend-value">${fmt(latest)}${metric.unit ? ` ${metric.unit}` : ""}</strong>
            </div>
            <svg class="spark" viewBox="0 0 320 68" preserveAspectRatio="none">
              <path d="${spark.path}"></path>
              <circle cx="${spark.lastX.toFixed(2)}" cy="${spark.lastY.toFixed(2)}" r="3"></circle>
            </svg>
            <div class="trend-delta ${klass}">${escapeHtml(deltaText)}</div>
          </article>
        `;
      }).join("");

      const firstDate = rows[0].date;
      const lastDate = rows[rows.length - 1].date;
      el.historyStatus.textContent = `Loaded ${rows.length} daily rows (${firstDate} → ${lastDate})`;
      el.trendGrid.innerHTML = cards;
      el.trendGrid.hidden = false;
    }

    function renderHistoryError(message) {
      el.trendGrid.hidden = true;
      el.historyStatus.innerHTML = `<span class="empty">${escapeHtml(message)}</span>`;
    }

    function renderSnapshot(metrics) {
      state.snapshot = metrics;

      el.mRestHr.textContent = fmt(metrics.restingHr);
      el.mHrv.textContent = fmt(metrics.hrv);
      el.mSleep.textContent = fmt(metrics.sleep);
      el.mBattery.textContent = fmt(metrics.battery);
      el.mStress.textContent = fmt(metrics.stress);
      el.mLoad.textContent = fmt(metrics.load);

      el.heroRestHr.textContent = fmt(metrics.restingHr);
      el.heroHrv.textContent = fmt(metrics.hrv);
      el.heroSleep.textContent = fmt(metrics.sleep);
      el.heroBattery.textContent = fmt(metrics.battery);

      el.snapshotStatus.innerHTML = metrics.timestamp
        ? `As of ${fmt(metrics.timestamp)}`
        : "Latest available snapshot";
      el.metricsGrid.hidden = false;
    }

    function renderSnapshotError(message) {
      el.metricsGrid.hidden = true;
      el.snapshotStatus.innerHTML = `<span class="empty">${message}</span>`;
    }

    function normalizeInsights(payload) {
      const raw = Array.isArray(payload)
        ? payload
        : Array.isArray(payload?.insights)
          ? payload.insights
          : Array.isArray(payload?.data)
            ? payload.data
            : (payload?.insight || payload?.message || payload?.text)
              ? [payload]
              : [];

      return expandCompositeInsights(raw);
    }

    function rawInsightText(item) {
      if (typeof item === "string") {
        return item;
      }
      return findFirst(item, ["insight", "message", "text", "summary", "content"]) || "";
    }

    function rawInsightAgent(item) {
      if (typeof item === "string") {
        return "agent";
      }
      return findFirst(item, ["agent", "agent_name", "source", "role"]) || "agent";
    }

    function rawInsightTime(item) {
      if (typeof item === "string") {
        return "";
      }
      return findFirst(item, ["timestamp", "created_at", "date", "time"]) || "";
    }

    function summarizeInsightText(text, maxLen = 320) {
      const blocks = text.split(/\n\s*\n/).map((part) => part.trim()).filter(Boolean);
      let best = blocks.find((part) => !/^\|/.test(part) && part.length >= 30) || blocks[0] || "";
      best = best.replace(/\s+/g, " ").trim();
      if (best.length <= maxLen) {
        return best;
      }
      return `${best.slice(0, maxLen - 3)}...`;
    }

    function formatSectionTitle(title) {
      return title
        .replace(/_/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function splitReportSections(text) {
      const lines = text.split(/\r?\n/);
      const sections = [];
      let title = "";
      let buffer = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        const next = (lines[i + 1] || "").trim();
        const next2 = (lines[i + 2] || "").trim();

        if (/^={8,}$/.test(line) && next && /^={8,}$/.test(next2)) {
          const content = buffer.join("\n").trim();
          if (content) {
            sections.push({
              title: title || "Daily Report",
              content
            });
          }
          title = formatSectionTitle(next);
          buffer = [];
          i += 2;
          continue;
        }

        buffer.push(lines[i]);
      }

      const tail = buffer.join("\n").trim();
      if (tail) {
        sections.push({
          title: title || "Daily Report",
          content: tail
        });
      }

      if (!sections.length && text.trim()) {
        return [{ title: "Daily Report", content: text.trim() }];
      }
      return sections;
    }

    function extractQuickWins(text, timestamp) {
      const lines = text.split(/\r?\n/);
      const wins = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        const match = line.match(/^RECOMMENDATION\s*\d*\s*:\s*(.+)$/i);
        if (!match) {
          continue;
        }

        const block = [line];
        let target = "";
        let direction = "";

        for (let j = i + 1; j < lines.length; j++) {
          const look = lines[j].trim();
          if (/^RECOMMENDATION\s*\d*\s*:/i.test(look)) {
            break;
          }
          block.push(lines[j]);
          const targetMatch = look.match(/^TARGET_METRIC\s*:\s*(.+)$/i);
          if (targetMatch) {
            target = targetMatch[1].trim();
          }
          const directionMatch = look.match(/^EXPECTED_DIRECTION\s*:\s*(.+)$/i);
          if (directionMatch) {
            direction = directionMatch[1].trim();
          }
        }

        const summaryParts = [match[1].trim()];
        if (target) {
          summaryParts.push(`Target: ${target}`);
        }
        if (direction) {
          summaryParts.push(`Expected: ${direction}`);
        }

        wins.push({
          agent: "Quick Win",
          summary: summaryParts.join(" • "),
          detail: block.join("\n").trim(),
          timestamp
        });

        if (wins.length >= 3) {
          break;
        }
      }

      return wins;
    }

    function expandCompositeInsights(items) {
      const expanded = [];

      for (const item of items) {
        const text = rawInsightText(item);
        const agent = rawInsightAgent(item);
        const timestamp = rawInsightTime(item);

        if (!text) {
          continue;
        }

        const sections = splitReportSections(text);
        const isComposite = sections.length > 1 || text.length > 1000;

        if (!isComposite) {
          expanded.push(item);
          continue;
        }

        const wins = extractQuickWins(text, timestamp);
        if (wins.length) {
          expanded.push(...wins);
        }

        for (const section of sections) {
          const detail = section.content.trim();
          if (!detail) {
            continue;
          }
          expanded.push({
            agent: section.title || agent,
            summary: summarizeInsightText(detail),
            detail,
            timestamp
          });
        }
      }

      return expanded.slice(0, 12);
    }

    function insightText(item) {
      if (typeof item === "string") {
        return item;
      }
      return findFirst(item, ["summary", "insight", "message", "text", "content"]) || "No text";
    }

    function insightAgent(item) {
      if (typeof item === "string") {
        return "agent";
      }
      return findFirst(item, ["agent", "agent_name", "source", "role"]) || "agent";
    }

    function insightTime(item) {
      if (typeof item === "string") {
        return "";
      }
      return findFirst(item, ["timestamp", "created_at", "date", "time"]) || "";
    }

    function insightDetail(item) {
      if (typeof item === "string") {
        return "";
      }
      return findFirst(item, ["detail", "text", "content", "raw"]) || "";
    }

    function renderInsights(items) {
      state.insights = items;

      if (!items.length) {
        el.insightsList.innerHTML = '<div class="empty">No insights returned yet. Trigger your pipeline and refresh.</div>';
        return;
      }

      const html = items.slice(0, 10).map((item) => {
        const summaryText = insightText(item);
        const summary = escapeHtml(summaryText).replace(/\n/g, "<br>");
        const agent = escapeHtml(String(insightAgent(item)).replace(/_/g, " "));
        const time = escapeHtml(insightTime(item));
        const detailRaw = insightDetail(item);
        const detail = escapeHtml(detailRaw);
        const hasDetail = detailRaw && detailRaw.trim() && detailRaw.trim() !== summaryText.trim();

        return `
          <article class="insight">
            <div class="insight-top">
              <span class="insight-agent">${agent}</span>
              ${time ? `<span class="insight-time">${time}</span>` : ""}
            </div>
            <p>${summary}</p>
            ${hasDetail ? `
              <details class="insight-detail">
                <summary>View full section</summary>
                <pre>${detail}</pre>
              </details>
            ` : ""}
          </article>
        `;
      }).join("");

      el.insightsList.innerHTML = html;
    }

    function renderInsightsError(message) {
      el.insightsList.innerHTML = `<div class="empty">${escapeHtml(message)}</div>`;
    }

    function appendMessage(role, text) {
      const node = document.createElement("div");
      node.className = `msg ${role}`;
      node.textContent = text;
      el.chatLog.appendChild(node);
      el.chatLog.scrollTop = el.chatLog.scrollHeight;
    }

    function escapeHtml(value) {
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    async function getJson(path) {
      const response = await fetch(endpoint(path), {
        method: "GET",
        headers: { "Accept": "application/json" },
        mode: "cors"
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const text = await response.text();
      if (!text) {
        return {};
      }

      try {
        return JSON.parse(text);
      } catch {
        return { raw: text };
      }
    }

    async function postJson(path, body) {
      const response = await fetch(endpoint(path), {
        method: "POST",
        headers: {
          "Accept": "application/json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body),
        mode: "cors"
      });

      if (!response.ok) {
        const errText = await response.text();
        throw new Error(errText || `HTTP ${response.status}`);
      }

      const text = await response.text();
      if (!text) {
        return {};
      }

      try {
        return JSON.parse(text);
      } catch {
        return { raw: text };
      }
    }

    async function loadHealth() {
      try {
        const result = await getJson("/health-check");
        const statusText =
          findFirst(result, ["status", "message"]) ||
          (Object.keys(result).length ? "Healthy" : "Online");

        if (/wake|boot|starting/i.test(statusText)) {
          setStatus("warm", "Waking up", "clock-3");
        } else {
          setStatus("ok", "Online", "check-circle-2");
        }
      } catch {
        setStatus("fail", "Offline", "x-circle");
      }
    }

    async function loadSnapshot() {
      el.snapshotStatus.innerHTML = '<span class="loading-row"><i data-lucide="loader-2" class="spin" style="width:14px;height:14px;"></i>Loading snapshot metrics...</span>';
      lucide.createIcons();

      try {
        const data = await getJson("/api/v1/snapshot/latest");
        const metrics = normalizeSnapshot(data);
        renderSnapshot(metrics);
      } catch (error) {
        renderSnapshotError(`Could not load snapshot (${error.message}).`);
      }
    }

    async function loadHistory() {
      el.historyStatus.innerHTML = '<span class="loading-row"><i data-lucide="loader-2" class="spin" style="width:14px;height:14px;"></i>Loading trend history...</span>';
      lucide.createIcons();

      try {
        const data = await getJson("/api/v1/metrics/history?days=90");
        const rows = normalizeHistory(data);
        renderHistory(rows);
      } catch (error) {
        renderHistoryError(`Could not load trend history (${error.message}).`);
      }
    }

    async function loadInsights() {
      el.insightsList.innerHTML = '<div class="loading-row"><i data-lucide="loader-2" class="spin" style="width:14px;height:14px;"></i>Loading latest insights...</div>';
      lucide.createIcons();

      try {
        const data = await getJson("/api/v1/insights/latest");
        const items = normalizeInsights(data);
        renderInsights(items);
      } catch (error) {
        renderInsightsError(`Could not load insights (${error.message}).`);
      }
    }

    async function sendChat(message) {
      appendMessage("user", message);
      appendMessage("bot", "Thinking...");
      const pendingNode = el.chatLog.lastElementChild;

      try {
        const result = await postJson("/api/v1/chat", { message });
        const reply = findFirst(result, ["answer", "response", "message", "text", "output"]) || "No response field returned by API.";
        pendingNode.textContent = String(reply);
      } catch (error) {
        pendingNode.textContent = `Request failed: ${error.message}`;
      }
    }

    function initEvents() {

      el.refreshSnapshotBtn.addEventListener("click", loadSnapshot);
      el.refreshHistoryBtn.addEventListener("click", loadHistory);
      el.refreshInsightsBtn.addEventListener("click", loadInsights);

      el.chatForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const message = el.chatInput.value.trim();
        if (!message) {
          return;
        }

        el.chatInput.value = "";
        el.sendBtn.disabled = true;

        await sendChat(message);

        el.sendBtn.disabled = false;
        el.chatInput.focus();
      });

      el.clearChatBtn.addEventListener("click", () => {
        el.chatLog.innerHTML = '<div class="msg system">Chat cleared.</div>';
      });

      el.chatInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          el.chatForm.requestSubmit();
        }
      });
    }

    async function boot() {
      await loadHealth();
      await Promise.all([loadSnapshot(), loadHistory(), loadInsights()]);
    }

    lucide.createIcons();
    initEvents();
    boot();
  </script>
</body>
</html>
